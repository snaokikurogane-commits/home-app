<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±±è¥¿ç”ºãƒ©ã‚¤ãƒ•</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0; padding-bottom: 90px; color: #333; }
        .container { padding: 15px; display: none; }
        .active { display: block; }
        .box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 15px; }
        h3 { margin-top: 0; color: #444; font-size: 18px; text-align: center; margin-bottom: 20px; letter-spacing: 0.05em; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; background: #f9f9f9; transition: 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #5D7EA7; background: #fff; outline: none; }
        
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s; }
        button:active { transform: scale(0.98); box-shadow: none; }
        
        .btn-blue { background: #5D7EA7; color: white; }
        .btn-green { background: #56AB91; color: white; }
        .btn-red { background: #E07A5F; color: white; }
        .btn-black { background: #3D405B; color: white; }
        
        .return-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .return-btn { padding: 20px 10px; border-radius: 15px; border: none; color: white; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .bg-naoki { background: linear-gradient(135deg, #6D8CAA, #486684); } 
        .bg-maki { background: linear-gradient(135deg, #F2C94C, #E0AA3E); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .category-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .cat-btn { padding: 15px; border: 1px solid #eee; background: #fff; border-radius: 10px; font-size: 14px; cursor: pointer; color: #555; transition: 0.2s; }
        .cat-btn.active-cat { background: #EAF2F8; border: 2px solid #5D7EA7; color: #486684; font-weight: bold; }
        
        .menu-row { display: flex; align-items: center; margin-bottom: 8px; }
        .menu-label { width: 30px; font-weight: bold; color: #777; font-size: 14px; }
        .menu-input { flex: 1; }
        .history-list { font-size: 13px; color: #555; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; line-height: 1.6; }
        .history-item { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; align-items: center; }

        .radio-group { display: flex; gap: 8px; margin: 10px 0; }
        .radio-label { flex: 1; text-align: center; padding: 12px; border: 1px solid #eee; border-radius: 10px; cursor: pointer; background: #fff; font-size: 14px; color: #555; transition: 0.2s; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label { background: #EAF2F8; border-color: #6D8CAA; color: #486684; font-weight: bold; }
        
        #shopping-ul, #schedule-ul, #bucket-ul { list-style: none; padding: 0; }
        #shopping-ul li, #schedule-ul li, #bucket-ul li { background: #fff; border-bottom: 1px solid #f0f0f0; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 15px; }
        .delete-btn { background: #E07A5F; color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; border: none; width: auto; margin: 0; }

        .photo-card { background: white; border-radius: 10px; overflow: hidden; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .photo-img { width: 100%; height: 200px; object-fit: cover; }
        .photo-meta { padding: 10px; }
        .photo-date { font-size: 12px; color: #888; }
        .photo-memo { font-weight: bold; color: #333; margin-top: 5px; }
        #upload-status { text-align:center; color:#56AB91; font-weight:bold; margin:10px 0; }

        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid #eee; display: flex; justify-content: space-between; padding: 8px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.03); z-index: 1000; overflow-x: auto; white-space: nowrap; }
        .nav-item { text-align: center; color: #999; font-size: 10px; cursor: pointer; min-width: 45px; display: inline-block; padding: 0 5px; transition: 0.2s; }
        .nav-item.active-tab { color: #486684; font-weight: bold; transform: translateY(-2px); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }
        
        #reader { width: 100%; border-radius: 15px; overflow: hidden; margin-bottom: 15px; background: #000; }
        .point-box { display: flex; justify-content: space-around; margin-top: 20px; }
        .point-card { text-align: center; width: 45%; padding: 15px; background: #f8f9fa; border-radius: 12px; border: 1px solid #eee; }
        .point-num { font-size: 36px; font-weight: bold; color: #F2C94C; display: block; margin-top: 5px; }
        
        .price-list { margin-top: 10px; }
        .price-item { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 5px; font-size: 13px; }
    </style>
</head>
<body>

    <div id="tab-return" class="container active">
        <div class="box">
            <h3>ğŸ  ä»Šã™ãå¸°ã‚Šã¾ã™</h3>
            <p style="text-align:center; font-size:12px; color:#888;">ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§é€šçŸ¥ã‚’é€ä¿¡</p>
            <div class="return-grid">
                <button class="return-btn bg-naoki" onclick="quickReturn('naoki', 'TRANSIT')"><span style="font-size:28px;">ğŸ¢ğŸšƒ</span>å°šè¼ é›»è»Š</button>
                <button class="return-btn bg-naoki" onclick="quickReturn('naoki', 'DRIVING')"><span style="font-size:28px;">ğŸ¢ğŸš—</span>å°šè¼ è»Š</button>
                <button class="return-btn bg-maki" onclick="quickReturn('maki', 'DRIVING')"><span style="font-size:28px;">ğŸ§¸ğŸ</span>çœŸè¼ ãƒã‚¤ã‚¯</button>
                <button class="return-btn bg-maki" onclick="quickReturn('maki', 'TRANSIT')"><span style="font-size:28px;">ğŸ§¸ğŸšƒ</span>çœŸè¼ é›»è»Š</button>
            </div>
            <div id="return-status" style="text-align:center; margin-top:15px; font-weight:bold; color:#486684;"></div>
        </div>
    </div>

    <div id="tab-photo" class="container">
        <div class="box">
            <h3>ğŸ½ æ–™ç†ã‚¢ãƒ«ãƒãƒ </h3>
            <label style="display:block; text-align:center; margin-bottom:10px; border: 2px dashed #ddd; padding: 20px; border-radius: 10px; background: #fafafa;">
                <span style="font-size:40px; cursor:pointer;">ğŸ“¸</span><br>
                <span style="font-size:14px; color:#5D7EA7; font-weight:bold;">æ’®å½± ã¾ãŸã¯ ã‚¢ãƒ«ãƒãƒ ã‹ã‚‰é¸æŠ</span>
                <input type="file" id="camera-input" accept="image/*" style="display:none;" onchange="handleFileSelect(this)">
            </label>
            <input type="text" id="photo-memo" placeholder="æ–™ç†åãƒ»ãƒ¡ãƒ¢ (ä»»æ„)">
            <button class="btn-green" onclick="uploadPhoto()">ä¿å­˜ã™ã‚‹</button>
            <div id="upload-status"></div>
            <hr style="margin:20px 0; border:0; border-top:1px dashed #ddd;">
            <input type="text" id="photo-search" placeholder="ğŸ” éå»ã®æ–™ç†ã‚’æ¤œç´¢..." oninput="filterPhotos()">
            <div id="photo-gallery"></div>
        </div>
    </div>

    <div id="tab-money" class="container">
        <div class="box">
            <h3>ğŸ’° ç¬é–“ãƒ»å®¶è¨ˆç°¿</h3>
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <input type="datetime-local" id="quick-date" style="flex: 2;">
                <div class="radio-group" style="flex: 1; margin: 0;">
                    <input type="radio" name="quick-type" id="t-exp" value="æ”¯å‡º" checked><label for="t-exp" class="radio-label">æ”¯å‡º</label>
                    <input type="radio" name="quick-type" id="t-inc" value="åå…¥"><label for="t-inc" class="radio-label">åå…¥</label>
                </div>
            </div>
            <input type="number" id="quick-amount" placeholder="é‡‘é¡ï¼ˆå††ï¼‰" inputmode="numeric" style="font-size:20px; text-align:center; padding: 15px;">
            <input type="text" id="quick-store" placeholder="åº—å (ä»»æ„)" style="text-align:center;">
            
            <div class="radio-group">
                <input type="radio" name="quick-owner" id="q-naoki" value="å°šè¼" checked><label for="q-naoki" class="radio-label">ğŸ¢å°šè¼</label>
                <input type="radio" name="quick-owner" id="q-maki" value="çœŸè¼"><label for="q-maki" class="radio-label">ğŸ§¸çœŸè¼</label>
                <input type="radio" name="quick-owner" id="q-joint" value="å…±åŒ"><label for="q-joint" class="radio-label">ğŸ å…±åŒ</label>
            </div>
            <div class="radio-group">
                <input type="radio" name="quick-method" id="m-cash" value="ç¾é‡‘" checked><label for="m-cash" class="radio-label">ğŸ’´ç¾é‡‘</label>
                <input type="radio" name="quick-method" id="m-card" value="ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰"><label for="m-card" class="radio-label">ğŸ’³ã‚«ãƒ¼ãƒ‰</label>
            </div>
            
            <label style="font-size:12px; color:#666; margin-top:10px; display:block;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</label>
            <div class="category-grid">
                <button class="cat-btn" id="cat-food" onclick="selectCategory('é£Ÿè²»', this)">ğŸ” é£Ÿè²»</button>
                <button class="cat-btn" id="cat-daily" onclick="selectCategory('æ—¥ç”¨å“', this)">ğŸ§» æ—¥ç”¨å“</button>
                <button class="cat-btn" id="cat-out" onclick="selectCategory('å¤–é£Ÿ', this)">ğŸ» å¤–é£Ÿ</button>
                <button class="cat-btn" id="cat-other" onclick="selectCategory('ãã®ä»–', this)">ğŸ’³ ãã®ä»–</button>
            </div>

            <button class="btn-green" style="margin-top:20px; font-size:18px;" onclick="submitQuickExpense()">âœ… è¨˜éŒ²ã™ã‚‹</button>
        </div>
    </div>

    <div id="tab-scan" class="container">
        <div class="box">
            <h3>ğŸ›’ åº•å€¤ç™»éŒ²</h3>
            <div id="reader"></div>
            <button class="btn-blue" onclick="startScan()">ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
            <input type="text" id="item" placeholder="å•†å“å">
            <input type="number" id="price" placeholder="ä¾¡æ ¼" inputmode="numeric">
            <input type="number" id="weight" placeholder="å†…å®¹é‡(g)" inputmode="numeric">
            <input type="text" id="store" placeholder="åº—å">
            <div id="unit-result" style="text-align:center; margin:10px 0; color:#666;">å˜ä¾¡ï¼š---</div>
            <button class="btn-green" onclick="submitPrice()">ç™»éŒ²</button>
            
            <hr style="margin:20px 0; border:0; border-top:1px dashed #ddd;">
            <h4 style="text-align:center; color:#888; font-size:13px;">ç™»éŒ²æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢</h4>
            <input type="text" id="price-search" placeholder="ğŸ” å•†å“åã§æ¤œç´¢ (ä¾‹: ç‰›ä¹³)" oninput="searchPrices()">
            <div id="price-list" class="price-list"></div>
        </div>
    </div>

    <div id="tab-list" class="container">
        <div class="box">
            <h3>ğŸ“ è²·ã†ã‚‚ã®ãƒªã‚¹ãƒˆ</h3>
            <div style="display:flex; gap:8px;">
                <input type="text" id="list-input" placeholder="ç‰›ä¹³ã€æ´—å‰¤ãªã©">
                <button class="btn-blue" style="width:30%; margin:8px 0;" onclick="addListItem()">è¿½åŠ </button>
            </div>
            <ul id="shopping-ul"></ul>
        </div>
    </div>

    <div id="tab-menu" class="container">
        <div class="box">
            <h3>ğŸ³ ä»Šé€±ã®çŒ®ç«‹</h3>
            <p style="text-align:center; font-size:12px; color:#888; margin-bottom:15px;">æœ€æ–°ã®ä¿å­˜å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
            <div class="menu-row"><span class="menu-label">æœˆ</span><input type="text" id="menu-mon" class="menu-input"></div>
            <div class="menu-row"><span class="menu-label">ç«</span><input type="text" id="menu-tue" class="menu-input"></div>
            <div class="menu-row"><span class="menu-label">æ°´</span><input type="text" id="menu-wed" class="menu-input"></div>
            <div class="menu-row"><span class="menu-label">æœ¨</span><input type="text" id="menu-thu" class="menu-input"></div>
            <div class="menu-row"><span class="menu-label">é‡‘</span><input type="text" id="menu-fri" class="menu-input"></div>
            <div class="menu-row"><span class="menu-label">åœŸ</span><input type="text" id="menu-sat" class="menu-input"></div>
            <div class="menu-row"><span class="menu-label">æ—¥</span><input type="text" id="menu-sun" class="menu-input"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-green" onclick="submitMenu()">ä¿å­˜ (å±¥æ­´ã«æ®‹ã‚‹)</button>
                <button class="btn-red" style="background:#E07A5F;" onclick="clearMenuInputs()">ã‚¯ãƒªã‚¢</button>
            </div>
            <hr style="margin:20px 0; border:0; border-top:1px dashed #ddd;">
            <h4 style="text-align:center; color:#888; font-size:13px;">éå»ã®çŒ®ç«‹å±¥æ­´</h4>
            <div id="menu-history" class="history-list"></div>
        </div>
    </div>

    <div id="tab-angry" class="container">
        <div class="box" style="border: 2px solid #3D405B;">
            <h3>ğŸ§¸ ãƒ ã‚«ãƒƒã¨ããŸã‚‰â€¦</h3>
            <p style="text-align:center; font-size:12px; color:#666;">æˆ‘æ…¢ã›ãšã«ã“ã“ã«åãå‡ºã—ã¦ãã ã•ã„ã€‚<br>å³åº§ã«é€šçŸ¥ã•ã‚Œã¾ã™ã€‚</p>
            <textarea id="angry-item" rows="4" placeholder="ï¼ˆä¾‹ï¼‰é´ä¸‹ãŒè„±ãã£ã±ãªã—ã§ã™ğŸ˜¡"></textarea>
            <button class="btn-black" onclick="submitAnger()">é€ä¿¡ã™ã‚‹ (å°šè¼ã¸é€šçŸ¥)</button>
        </div>
    </div>

    <div id="tab-schedule" class="container">
        <div class="box">
            <h3>ğŸ“… äºˆå®šç™»éŒ²</h3>
            <input type="text" id="event-name" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆå">
            <input type="date" id="event-date">
            <div class="radio-group">
                <input type="radio" name="owner" id="naoki" value="naoki"><label for="naoki" class="radio-label">ğŸ¢å°šè¼</label>
                <input type="radio" name="owner" id="maki" value="maki"><label for="maki" class="radio-label">ğŸ§¸çœŸè¼</label>
                <input type="radio" name="owner" id="common" value="common" checked><label for="common" class="radio-label">ğŸ 2äºº</label>
            </div>
            <button class="btn-green" onclick="submitEvent()">ç™»éŒ²</button>
            <hr style="margin:20px 0; border:0; border-top:1px dashed #ddd;">
            <h4 style="text-align:center; color:#888; font-size:13px;">ä»Šå¾Œã®äºˆå®šãƒªã‚¹ãƒˆ</h4>
            <ul id="schedule-ul"></ul>
        </div>
    </div>

    <div id="tab-bucket" class="container">
        <div class="box">
            <h3>âœ¨ ã‚„ã‚ŠãŸã„ã“ã¨</h3>
            <input type="text" id="bucket-item" placeholder="ä¾‹ï¼šåŒ—æµ·é“ã§ã‚«ãƒ‹">
            <div style="display:flex; gap:10px;">
                <input type="date" id="bucket-limit" style="flex:1;">
                <select id="bucket-rank" style="flex:1;">
                    <option value="â˜…">â˜… æ‰‹è»½</option>
                    <option value="â˜…â˜…">â˜…â˜… æ™®é€š</option>
                    <option value="â˜…â˜…â˜…">â˜…â˜…â˜… æŒ‘æˆ¦</option>
                </select>
            </div>
            <div class="radio-group">
                <input type="radio" name="bucket-owner" id="b-naoki" value="naoki"><label for="b-naoki" class="radio-label">ğŸ¢å°šè¼</label>
                <input type="radio" name="bucket-owner" id="b-maki" value="maki"><label for="b-maki" class="radio-label">ğŸ§¸çœŸè¼</label>
                <input type="radio" name="bucket-owner" id="b-common" value="common" checked><label for="b-common" class="radio-label">ğŸ 2äºº</label>
            </div>
            <button class="btn-green" onclick="submitBucket()">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
            <hr style="margin:20px 0; border:0; border-top:1px dashed #ddd;">
            <h4 style="text-align:center; color:#888; font-size:13px;">å¤¢ãƒªã‚¹ãƒˆä¸€è¦§</h4>
            <ul id="bucket-ul"></ul>
        </div>
    </div>

    <div id="tab-pay" class="container">
        <div class="box">
            <h3>ğŸ’¸ ç«‹æ›¿è¨˜éŒ²</h3>
            <input type="text" id="pay-item" placeholder="ä½•ã«ä½¿ã£ãŸï¼Ÿ">
            <input type="number" id="pay-amount" placeholder="é‡‘é¡" inputmode="numeric">
            <div class="radio-group">
                <input type="radio" name="payer" id="pay-naoki" value="å°šè¼" checked><label for="pay-naoki" class="radio-label">ğŸ¢å°šè¼æ‰•</label>
                <input type="radio" name="payer" id="pay-maki" value="çœŸè¼"><label for="pay-maki" class="radio-label">ğŸ§¸çœŸè¼æ‰•</label>
            </div>
            <button class="btn-green" onclick="submitPayment()">è¨˜éŒ²</button>
            <hr style="margin:20px 0; border:0; border-top:1px dashed #ddd;">
            <h4 style="text-align:center; color:#888; font-size:13px;">æœ€è¿‘ã®å±¥æ­´</h4>
            <div id="pay-history" class="history-list"></div>
        </div>
    </div>

    <div id="tab-love" class="container">
        <div class="box">
            <h3>â¤ï¸ æ„Ÿè¬ãƒã‚¤ãƒ³ãƒˆ</h3>
            <div style="display:flex; gap:12px;">
                <button class="btn-blue" onclick="addPoint('naoki')">ğŸ¢ å°šè¼ã¸</button>
                <button class="btn-red" onclick="addPoint('maki')">ğŸ§¸ çœŸè¼ã¸</button>
            </div>
            <div class="point-box">
                <div class="point-card">ğŸ¢å°šè¼<span id="pt-naoki" class="point-num">0</span></div>
                <div class="point-card">ğŸ§¸çœŸè¼<span id="pt-maki" class="point-num">0</span></div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active-tab" onclick="switchTab('return')"><span class="nav-icon">ğŸ </span>å¸°</div>
        <div class="nav-item" onclick="switchTab('money')"><span class="nav-icon">ğŸ’°</span>é‡‘</div>
        <div class="nav-item" onclick="switchTab('scan')"><span class="nav-icon">ğŸ›’</span>åº•</div>
        <div class="nav-item" onclick="switchTab('list')"><span class="nav-icon">ğŸ“</span>è²·</div>
        <div class="nav-item" onclick="switchTab('menu')"><span class="nav-icon">ğŸ³</span>çŒ®</div>
        <div class="nav-item" onclick="switchTab('photo')"><span class="nav-icon">ğŸ“¸</span>æ’®</div>
        <div class="nav-item" onclick="switchTab('angry')"><span class="nav-icon">ğŸ§¸</span>æ€’</div>
        <div class="nav-item" onclick="switchTab('schedule')"><span class="nav-icon">ğŸ“…</span>äºˆ</div>
        <div class="nav-item" onclick="switchTab('bucket')"><span class="nav-icon">âœ¨</span>å¤¢</div>
        <div class="nav-item" onclick="switchTab('pay')"><span class="nav-icon">ğŸ’¸</span>ç«‹</div>
        <div class="nav-item" onclick="switchTab('love')"><span class="nav-icon">â¤ï¸</span>æ„Ÿ</div>
    </div>

    <script>
        // â˜…â˜…â˜…ã“ã“ã«GASã®URLã‚’è²¼ã‚‹â˜…â˜…â˜…
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwNlvtmCeDJ1bZzelDvACag056x1GVMWmQFv14HBrJVooE8HVV0WjWEsM_5I9xxNTCy/exec";

        function switchTab(tabName) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-tab'));
            document.getElementById('tab-' + tabName).classList.add('active');
            const tabs = ['return','money','scan','list','menu','photo','angry','schedule','bucket','pay','love'];
            const idx = tabs.indexOf(tabName);
            if(idx >= 0) document.querySelectorAll('.nav-item')[idx].classList.add('active-tab');

            if(tabName === 'list') loadShoppingList();
            if(tabName === 'menu') loadMenu();
            if(tabName === 'love') loadPoints();
            if(tabName === 'schedule') loadSchedules();
            if(tabName === 'photo') loadPhotos(); 
            if(tabName === 'pay') loadPaymentHistory(); 
            if(tabName === 'bucket') loadBucketList(); // â˜…è¿½åŠ 
            if(tabName === 'scan') loadPriceList(); // â˜…è¿½åŠ 
            if(tabName === 'money') {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('quick-date').value = now.toISOString().slice(0,16);
            }
        }
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const tab = params.get('tab');
            if (tab) switchTab(tab); else switchTab('return');
        }

        // --- 10. å†™çœŸã‚¢ãƒ«ãƒãƒ  ---
        let selectedFileBase64 = null;
        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            document.getElementById('upload-status').innerText = "åœ§ç¸®ä¸­...";
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_SIZE = 800;
                    let width = img.width; let height = img.height;
                    if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    selectedFileBase64 = canvas.toDataURL("image/jpeg", 0.7).split(',')[1];
                    document.getElementById('upload-status').innerText = "æº–å‚™å®Œäº†ï¼ã€Œä¿å­˜ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„";
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        async function uploadPhoto() {
            if(!selectedFileBase64) return alert("å†™çœŸã‚’æ’®å½±ã¾ãŸã¯é¸æŠã—ã¦ãã ã•ã„");
            document.getElementById('upload-status').innerText = "ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­... (æ•°ç§’ã‹ã‹ã‚Šã¾ã™)";
            const memo = document.getElementById('photo-memo').value;
            try {
                const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "upload_photo", image: selectedFileBase64, memo: memo }) });
                const data = await res.json();
                if(data.status === "success") { alert("ä¿å­˜ã—ã¾ã—ãŸï¼ğŸ½"); document.getElementById('upload-status').innerText = ""; document.getElementById('photo-memo').value = ""; selectedFileBase64 = null; loadPhotos(); } else { alert("ã‚¨ãƒ©ãƒ¼: " + data.msg); }
            } catch(e) { alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼"); }
        }
        let allPhotos = [];
        async function loadPhotos() {
            document.getElementById('photo-gallery').innerText = "èª­ã¿è¾¼ã¿ä¸­...";
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "get_photos" }) });
            const data = await res.json();
            allPhotos = data.items || [];
            renderPhotos(allPhotos);
        }
        function renderPhotos(photos) {
            const gallery = document.getElementById('photo-gallery'); gallery.innerHTML = "";
            if(photos.length === 0) { gallery.innerHTML = "<p style='text-align:center; color:#999;'>å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</p>"; return; }
            photos.forEach(p => { const d = new Date(p.date); const dateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; const div = document.createElement('div'); div.className = 'photo-card'; div.innerHTML = `<img src="${p.url}" class="photo-img" loading="lazy"><div class="photo-meta"><div class="photo-date">${dateStr}</div><div class="photo-memo">${p.memo}</div></div>`; gallery.appendChild(div); });
        }
        function filterPhotos() {
            const query = document.getElementById('photo-search').value.toLowerCase();
            const filtered = allPhotos.filter(p => (p.memo && p.memo.toLowerCase().includes(query)) || (p.date && p.date.includes(query)));
            renderPhotos(filtered);
        }

        // --- 0. ä»Šã™ãå¸°ã‚Šã¾ã™ ---
        function quickReturn(who, mode) {
            document.getElementById('return-status').innerText = "ğŸ“ ä½ç½®æƒ…å ±å–å¾—ä¸­...";
            if (!navigator.geolocation) { alert("GPSåˆ©ç”¨ä¸å¯"); return; }
            navigator.geolocation.getCurrentPosition(async (pos) => {
                document.getElementById('return-status').innerText = "ğŸš€ è¨ˆç®—ä¸­...";
                const payload = { type: "web_app", action: "quick_return", lat: pos.coords.latitude, lon: pos.coords.longitude, owner: who, mode: mode };
                const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
                const data = await res.json();
                document.getElementById('return-status').innerText = (data.status === "success") ? "âœ… é€ä¿¡å®Œäº†ï¼" : "ã‚¨ãƒ©ãƒ¼";
                if(data.status==="success") alert(data.msg);
            }, (err) => { document.getElementById('return-status').innerText = "âš ï¸ GPSã‚¨ãƒ©ãƒ¼"; });
        }

        // --- 1. ç¬é–“å®¶è¨ˆç°¿ ---
        let selectedCategory = "";
        function selectCategory(cat, btnElement) {
            selectedCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active-cat'));
            btnElement.classList.add('active-cat');
        }
        async function submitQuickExpense() {
            const date = document.getElementById('quick-date').value;
            const type = document.querySelector('input[name="quick-type"]:checked').value;
            const amount = document.getElementById('quick-amount').value;
            const store = document.getElementById('quick-store').value;
            const owner = document.querySelector('input[name="quick-owner"]:checked').value;
            const method = document.querySelector('input[name="quick-method"]:checked').value;
            
            if(!amount) return alert("é‡‘é¡ã‚’å…¥ã‚Œã¦ãã ã•ã„");
            if(!selectedCategory) return alert("ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„");

            if(confirm(`ã€${selectedCategory}ã€‘${amount}å††\næ—¥æ™‚ï¼š${date}\nç¨®é¡ï¼š${type}\näººï¼š${owner} (${method})\n\nè¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
                await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ 
                    type: "web_app", action: "quick_expense", 
                    date: date, type: type, amount: amount, category: selectedCategory, payer: owner, method: method, store: store 
                }) });
                alert("è¨˜éŒ²ã—ã¾ã—ãŸï¼ğŸ’°"); 
                document.getElementById('quick-amount').value = ""; document.getElementById('quick-store').value = "";
                selectedCategory = ""; document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active-cat'));
            }
        }
        
        // --- 8. çŒ®ç«‹ ---
        async function submitMenu() {
            if(!confirm("ã“ã®å†…å®¹ã§çŒ®ç«‹ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return;
            const payload = { type: "web_app", action: "register_menu", mon: document.getElementById('menu-mon').value, tue: document.getElementById('menu-tue').value, wed: document.getElementById('menu-wed').value, thu: document.getElementById('menu-thu').value, fri: document.getElementById('menu-fri').value, sat: document.getElementById('menu-sat').value, sun: document.getElementById('menu-sun').value };
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
            alert("ä¿å­˜ã—ã¾ã—ãŸï¼ğŸ“…"); loadMenu();
        }
        function clearMenuInputs() {
            if(!confirm("å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return;
            document.getElementById('menu-mon').value = ""; document.getElementById('menu-tue').value = ""; document.getElementById('menu-wed').value = ""; document.getElementById('menu-thu').value = ""; document.getElementById('menu-fri').value = ""; document.getElementById('menu-sat').value = ""; document.getElementById('menu-sun').value = "";
        }
        async function loadMenu() {
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "get_menu" }) });
            const data = await res.json();
            if(data.menu) { document.getElementById('menu-mon').value = data.menu.mon || ""; document.getElementById('menu-tue').value = data.menu.tue || ""; document.getElementById('menu-wed').value = data.menu.wed || ""; document.getElementById('menu-thu').value = data.menu.thu || ""; document.getElementById('menu-fri').value = data.menu.fri || ""; document.getElementById('menu-sat').value = data.menu.sat || ""; document.getElementById('menu-sun').value = data.menu.sun || ""; }
            const historyDiv = document.getElementById('menu-history'); historyDiv.innerHTML = "";
            if(data.history) { data.history.forEach(h => { const d = new Date(h.date); const dateStr = `${d.getMonth()+1}/${d.getDate()}`; historyDiv.innerHTML += `<div class="history-item"><strong>${dateStr}æ›´æ–°</strong><br>${h.menuStr}</div>`; }); }
        }

        // --- 9. ãƒ ã‚«ãƒƒã¨ããŸã‚‰ ---
        async function submitAnger() {
            const item = document.getElementById('angry-item').value;
            if(!item) return alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if(confirm(`ã€${item}ã€‘\n\nå°šè¼ã•ã‚“ã«é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) {
                const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "register_anger", item: item, owner: "maki" }) });
                const data = await res.json();
                let msg = "é€ä¿¡ã—ã¾ã—ãŸã€‚";
                if (data.penalty) msg += `\n\nğŸš¨ 2å›è“„ç©ï¼\nğŸ° å°šè¼ã•ã‚“ã‹ã‚‰ã€Œãƒãƒƒã‚µãƒ¼ã‚¸orãƒ‡ã‚¶ãƒ¼ãƒˆã€ã®åˆ‘ãŒåŸ·è¡Œã•ã‚Œã¾ã™ã€‚`;
                alert(msg); document.getElementById('angry-item').value = "";
            }
        }

        // --- 6. ç«‹æ›¿ ---
        async function submitPayment() {
            const item = document.getElementById('pay-item').value;
            const amount = document.getElementById('pay-amount').value;
            const payer = document.querySelector('input[name="payer"]:checked').value;
            if(!item || !amount) return;
            if(confirm(`${payer}ãŒ ${amount}å††\n(${item})\n\nè¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
                await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "register_payment", item: item, amount: amount, payer: payer }) });
                alert("è¨˜éŒ²ã—ã¾ã—ãŸï¼"); document.getElementById('pay-item').value = ""; document.getElementById('pay-amount').value = "";
                loadPaymentHistory(); 
            }
        }
        async function loadPaymentHistory() {
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "get_payment_history" }) });
            const data = await res.json();
            const div = document.getElementById('pay-history');
            div.innerHTML = "";
            if(data.items) {
                data.items.forEach(h => {
                    const d = new Date(h.date);
                    const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
                    div.innerHTML += `<div class="history-item"><strong>${dateStr}</strong> ${h.payer}: ${h.amount}å†† (${h.item})</div>`;
                });
            }
        }

        // --- 5. ã‚„ã‚ŠãŸã„ã“ã¨ãƒªã‚¹ãƒˆ (â˜…æ–°æ©Ÿèƒ½) ---
        async function submitBucket() { 
            const item = document.getElementById('bucket-item').value; 
            const owner = document.querySelector('input[name="bucket-owner"]:checked').value; 
            const limit = document.getElementById('bucket-limit').value;
            const rank = document.getElementById('bucket-rank').value;
            if(!item) return; 
            if(confirm(`ã€${item}ã€‘\n\nãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) { 
                await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "register_bucket", item: item, owner: owner, limit: limit, rank: rank }) }); 
                alert("è¿½åŠ ã—ã¾ã—ãŸï¼âœ¨"); document.getElementById('bucket-item').value = ""; 
                loadBucketList();
            } 
        }
        async function loadBucketList() {
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "get_bucket_list" }) });
            const data = await res.json();
            const ul = document.getElementById('bucket-ul'); ul.innerHTML = "";
            data.items.forEach(b => {
                const li = document.createElement('li');
                let icon = "ğŸ "; if(b.owner === "naoki") icon = "ğŸ¢"; if(b.owner === "maki") icon = "ğŸ§¸";
                li.innerHTML = `<span>${icon} ${b.item} (${b.rank})</span> <button class="delete-btn" onclick="deleteBucket('${b.item}')">é”æˆ</button>`;
                ul.appendChild(li);
            });
        }
        async function deleteBucket(item) {
            if(!confirm("ã“ã®å¤¢ã‚’é”æˆã—ã¾ã—ãŸã‹ï¼Ÿï¼ˆãƒªã‚¹ãƒˆã‹ã‚‰æ¶ˆãˆã¾ã™ï¼‰")) return;
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "delete_bucket_item", item: item }) });
            loadBucketList();
        }

        // --- 2. åº•å€¤æ¤œç´¢ (â˜…æ–°æ©Ÿèƒ½) ---
        let allPrices = [];
        async function loadPriceList() {
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "get_price_list" }) });
            const data = await res.json();
            allPrices = data.items || [];
            searchPrices(); // åˆæœŸè¡¨ç¤º
        }
        function searchPrices() {
            const query = document.getElementById('price-search').value.toLowerCase();
            const filtered = allPrices.filter(p => p.item.toLowerCase().includes(query));
            const div = document.getElementById('price-list');
            div.innerHTML = "";
            
            // æœ€å¤§10ä»¶è¡¨ç¤º
            filtered.slice(0, 10).forEach(p => {
                let unitPrice = "";
                if(p.price && p.weight) unitPrice = `(@${Math.round((p.price/p.weight)*100)}å††/100g)`;
                div.innerHTML += `<div class="price-item">
                    <strong>${p.item}</strong> ${p.price}å†† ${unitPrice}<br>
                    <span style="color:#666;">ğŸª ${p.store} (${new Date(p.date).toLocaleDateString()})</span>
                </div>`;
            });
        }

        // --- ãã®ä»–å…±é€š ---
        async function submitEvent() { const name = document.getElementById('event-name').value; const date = document.getElementById('event-date').value; const owner = document.querySelector('input[name="owner"]:checked').value; if(!name || !date) return; if(confirm("ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) { await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "register_event", name: name, date: date, owner: owner }) }); alert("ç™»éŒ²å®Œäº†ï¼"); document.getElementById('event-name').value = ""; loadSchedules(); } }
        async function loadSchedules() { const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "get_schedules" }) }); const data = await res.json(); const ul = document.getElementById('schedule-ul'); ul.innerHTML = ""; data.items.forEach(e => { const li = document.createElement('li'); let icon = "ğŸ "; if(e.owner === "naoki") icon = "ğŸ¢"; if(e.owner === "maki") icon = "ğŸ§¸"; const d = new Date(e.date); li.innerHTML = `${icon} ${d.getMonth()+1}/${d.getDate()} ${e.name}`; ul.appendChild(li); }); }
        const scanner = new Html5Qrcode("reader");
        function startScan() { scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => { scanner.stop(); fetchItem(text); }); }
        async function fetchItem(jan) { const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "search_jan", jan: jan }) }); const data = await res.json(); document.getElementById('item').value = data.itemName || ""; }
        document.getElementById('price').addEventListener('input', () => { const p = document.getElementById('price').value, w = document.getElementById('weight').value; if(p&&w) document.getElementById('unit-result').innerText = `å˜ä¾¡ï¼š${Math.round((p/w)*100)} å††`; });
        async function submitPrice() { await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "register_price", item: document.getElementById('item').value, price: document.getElementById('price').value, weight: document.getElementById('weight').value, store: document.getElementById('store').value }) }); alert("ç™»éŒ²ã—ã¾ã—ãŸï¼"); loadPriceList(); } // ç™»éŒ²å¾Œã«ãƒªã‚¹ãƒˆæ›´æ–°
        async function loadShoppingList() { const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "get_shopping_list" }) }); const data = await res.json(); const ul = document.getElementById('shopping-ul'); ul.innerHTML = ""; data.items.forEach(item => { const li = document.createElement('li'); li.innerHTML = `<span>${item}</span> <button class="delete-btn" onclick="deleteItem('${item}')">å®Œäº†</button>`; ul.appendChild(li); }); }
        async function addListItem() { const item = document.getElementById('list-input').value; if(!item) return; await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "add_shopping_item", item: item }) }); document.getElementById('list-input').value = ""; loadShoppingList(); }
        async function deleteItem(item) { if(!confirm("è²·ã„ã¾ã—ãŸã‹ï¼Ÿ")) return; await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "delete_shopping_item", item: item }) }); loadShoppingList(); }
        async function addPoint(to) { let confirmMsg = (to === 'naoki') ? "å°šè¼ã•ã‚“ã«æ„Ÿè¬ã‚’ä¼ãˆã¾ã™ã‹ï¼Ÿ" : "çœŸè¼ã•ã‚“ã«æ„Ÿè¬ã‚’ä¼ãˆã¾ã™ã‹ï¼Ÿ"; if(confirm(confirmMsg)) { const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "add_point", to: to }) }); const data = await res.json(); if (data.reward) { let msg = (to === 'naoki') ? `ğŸ‰ ç¥ï¼å°šè¼ã•ã‚“ãŒ ${data.total}ãƒã‚¤ãƒ³ãƒˆé”æˆï¼\n\nğŸ’†â€â™€ï¸ çœŸè¼ã•ã‚“ã€å°šè¼ã•ã‚“ã«\nã€Œãƒãƒƒã‚µãƒ¼ã‚¸ã€ã‚’ã—ã¦ã‚ã’ã¦ãã ã•ã„ï¼` : `ğŸ‰ ç¥ï¼çœŸè¼ã•ã‚“ãŒ ${data.total}ãƒã‚¤ãƒ³ãƒˆé”æˆï¼\n\nğŸ’†â€â™‚ï¸ å°šè¼ã•ã‚“ã€çœŸè¼ã•ã‚“ã«\nã€Œãƒãƒƒã‚µãƒ¼ã‚¸ã€ã‚’ã—ã¦ã‚ã’ã¦ãã ã•ã„ï¼`; alert(msg); } else { alert(`æ„Ÿè¬ã‚’ä¼ãˆã¾ã—ãŸï¼\n(ç¾åœ¨: ${data.total}ãƒã‚¤ãƒ³ãƒˆ)`); } loadPoints(); } }
        async function loadPoints() { const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "get_points" }) }); const data = await res.json(); document.getElementById('pt-naoki').innerText = data.naoki; document.getElementById('pt-maki').innerText = data.maki; }
    </script>
</body>
</html>
