<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±±è¥¿ç”ºãƒ©ã‚¤ãƒ•</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 0; padding-bottom: 90px; }
        .container { padding: 15px; display: none; }
        .active { display: block; }
        .box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h3 { margin-top: 0; color: #333; font-size: 18px; text-align: center; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-blue { background: #007aff; color: white; }
        .btn-green { background: #34c759; color: white; }
        .btn-red { background: #ff3b30; color: white; }
        .btn-orange { background: #ff9500; color: white; }
        .btn-black { background: #333; color: white; } 
        
        /* çŒ®ç«‹ */
        .menu-row { display: flex; align-items: center; margin-bottom: 8px; }
        .menu-label { width: 30px; font-weight: bold; color: #555; }
        .menu-input { flex: 1; }
        .history-list { font-size: 12px; color: #666; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .history-item { margin-bottom: 5px; }

        /* å¸°å®…ãƒœã‚¿ãƒ³ */
        .return-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .return-btn { padding: 15px; border-radius: 12px; border: none; color: white; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .bg-naoki { background: linear-gradient(135deg, #007aff, #00c6ff); }
        .bg-maki { background: linear-gradient(135deg, #ff9500, #ffcc00); }
        /* å®¶è¨ˆç°¿ */
        .category-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .cat-btn { padding: 15px; border: 1px solid #ddd; background: #fff; border-radius: 8px; font-size: 14px; cursor: pointer; }
        /* ã‚¢ã‚¤ã‚³ãƒ³ */
        .radio-group { display: flex; gap: 5px; margin: 10px 0; }
        .radio-label { flex: 1; text-align: center; padding: 10px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; background: #f9f9f9; font-size: 14px; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label { background: #e0f0ff; border-color: #007aff; color: #007aff; font-weight: bold; }
        /* ãƒªã‚¹ãƒˆ */
        #shopping-ul, #schedule-ul { list-style: none; padding: 0; }
        #shopping-ul li, #schedule-ul li { background: #fff; border-bottom: 1px solid #eee; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .delete-btn { background: #ff3b30; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; border: none; width: auto; margin: 0; }
        /* ãƒŠãƒ“ */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-between; padding: 8px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; overflow-x: auto; white-space: nowrap; }
        .nav-item { text-align: center; color: #888; font-size: 9px; cursor: pointer; min-width: 50px; display: inline-block; padding: 0 5px; }
        .nav-item.active-tab { color: #007aff; font-weight: bold; }
        .nav-icon { font-size: 18px; display: block; margin-bottom: 2px; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; margin-bottom: 15px; background: #000; }
        /* ãƒã‚¤ãƒ³ãƒˆ */
        .point-box { display: flex; justify-content: space-around; margin-top: 20px; }
        .point-card { text-align: center; width: 45%; padding: 10px; background: #f9f9f9; border-radius: 10px; }
        .point-num { font-size: 32px; font-weight: bold; color: #ff9500; }
    </style>
</head>
<body>

    <div id="tab-return" class="container active">
        <div class="box">
            <h3>ğŸ  ä»Šã™ãå¸°ã‚Šã¾ã™</h3>
            <div class="return-grid">
                <button class="return-btn bg-naoki" onclick="quickReturn('naoki', 'TRANSIT')"><span style="font-size:24px;">ğŸ¢ğŸšƒ</span>å°šè¼ é›»è»Š</button>
                <button class="return-btn bg-naoki" onclick="quickReturn('naoki', 'DRIVING')"><span style="font-size:24px;">ğŸ¢ğŸš—</span>å°šè¼ è»Š</button>
                <button class="return-btn bg-maki" onclick="quickReturn('maki', 'DRIVING')"><span style="font-size:24px;">ğŸ§¸ğŸ</span>çœŸè¼ ãƒã‚¤ã‚¯</button>
                <button class="return-btn bg-maki" onclick="quickReturn('maki', 'TRANSIT')"><span style="font-size:24px;">ğŸ§¸ğŸšƒ</span>çœŸè¼ é›»è»Š</button>
            </div>
            <div id="return-status" style="text-align:center; margin-top:15px; font-weight:bold; color:#007aff;"></div>
        </div>
    </div>

    <div id="tab-money" class="container">
        <div class="box">
            <h3>ğŸ’° ç¬é–“ãƒ»å®¶è¨ˆç°¿</h3>
            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                <input type="datetime-local" id="quick-date" style="flex: 2;">
                <div class="radio-group" style="flex: 1; margin: 0;">
                    <input type="radio" name="quick-type" id="t-exp" value="æ”¯å‡º" checked><label for="t-exp" class="radio-label">æ”¯å‡º</label>
                    <input type="radio" name="quick-type" id="t-inc" value="åå…¥"><label for="t-inc" class="radio-label">åå…¥</label>
                </div>
            </div>
            <label style="font-size:12px; color:#666;">é‡‘é¡ãƒ»åº—å</label>
            <input type="number" id="quick-amount" placeholder="é‡‘é¡ï¼ˆå††ï¼‰" inputmode="numeric" style="font-size:20px; text-align:center;">
            <input type="text" id="quick-store" placeholder="åº—å (ä»»æ„)" style="text-align:center;">
            <label style="font-size:12px; color:#666;">è² æ‹…è€…</label>
            <div class="radio-group">
                <input type="radio" name="quick-owner" id="q-naoki" value="å°šè¼" checked><label for="q-naoki" class="radio-label">ğŸ¢å°šè¼</label>
                <input type="radio" name="quick-owner" id="q-maki" value="çœŸè¼"><label for="q-maki" class="radio-label">ğŸ§¸çœŸè¼</label>
                <input type="radio" name="quick-owner" id="q-joint" value="å…±åŒ"><label for="q-joint" class="radio-label">ğŸ å…±åŒ</label>
            </div>
            <label style="font-size:12px; color:#666;">æ”¯æ‰•æ–¹æ³•</label>
            <div class="radio-group">
                <input type="radio" name="quick-method" id="m-cash" value="ç¾é‡‘" checked><label for="m-cash" class="radio-label">ğŸ’´ç¾é‡‘</label>
                <input type="radio" name="quick-method" id="m-card" value="ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰"><label for="m-card" class="radio-label">ğŸ’³ã‚«ãƒ¼ãƒ‰</label>
            </div>
            <label style="font-size:12px; color:#666; margin-top:10px; display:block;">ã‚«ãƒ†ã‚´ãƒª</label>
            <div class="category-grid">
                <button class="cat-btn" onclick="quickExpense('é£Ÿè²»')">ğŸ” é£Ÿè²»</button>
                <button class="cat-btn" onclick="quickExpense('æ—¥ç”¨å“')">ğŸ§» æ—¥ç”¨å“</button>
                <button class="cat-btn" onclick="quickExpense('å¤–é£Ÿ')">ğŸ» å¤–é£Ÿ</button>
                <button class="cat-btn" onclick="quickExpense('ãã®ä»–')">ğŸ’³ ãã®ä»–</button>
            </div>
        </div>
    </div>

    <div id="tab-scan" class="container">
        <div class="box">
            <h3>ğŸ›’ åº•å€¤ç™»éŒ²</h3>
            <div id="reader"></div>
            <button class="btn-blue" onclick="startScan()">ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
            <input type="text" id="item" placeholder="å•†å“å">
            <input type="number" id="price" placeholder="ä¾¡æ ¼" inputmode="numeric">
            <input type="number" id="weight" placeholder="å†…å®¹é‡(g)" inputmode="numeric">
            <input type="text" id="store" placeholder="åº—å">
            <div id="unit-result" style="text-align:center; margin:10px 0;">å˜ä¾¡ï¼š---</div>
            <button class="btn-green" onclick="submitPrice()">ç™»éŒ²</button>
        </div>
    </div>

    <div id="tab-list" class="container">
        <div class="box">
            <h3>ğŸ“ è²·ã†ã‚‚ã®ãƒªã‚¹ãƒˆ</h3>
            <div style="display:flex; gap:5px;">
                <input type="text" id="list-input" placeholder="ç‰›ä¹³ã€æ´—å‰¤ãªã©">
                <button class="btn-blue" style="width:30%; margin:8px 0;" onclick="addListItem()">è¿½åŠ </button>
            </div>
            <ul id="shopping-ul"></ul>
        </div>
    </div>

    <div id="tab-menu" class="container">
        <div class="box">
            <h3>ğŸ³ ä»Šé€±ã®çŒ®ç«‹</h3>
            <p style="text-align:center; font-size:12px; color:#666;">æœ€æ–°ã®ä¿å­˜å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
            <div class="menu-row"><span class="menu-label">æœˆ</span><input type="text" id="menu-mon" class="menu-input"></div>
            <div class="menu-row"><span class="menu-label">ç«</span><input type="text" id="menu-tue" class="menu-input"></div>
            <div class="menu-row"><span class="menu-label">æ°´</span><input type="text" id="menu-wed" class="menu-input"></div>
            <div class="menu-row"><span class="menu-label">æœ¨</span><input type="text" id="menu-thu" class="menu-input"></div>
            <div class="menu-row"><span class="menu-label">é‡‘</span><input type="text" id="menu-fri" class="menu-input"></div>
            <div class="menu-row"><span class="menu-label">åœŸ</span><input type="text" id="menu-sat" class="menu-input"></div>
            <div class="menu-row"><span class="menu-label">æ—¥</span><input type="text" id="menu-sun" class="menu-input"></div>
            
            <div style="display:flex; gap:10px;">
                <button class="btn-green" onclick="submitMenu()">ä¿å­˜ (å±¥æ­´ã«æ®‹ã‚‹)</button>
                <button class="btn-red" onclick="clearMenuInputs()">å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
            </div>

            <hr style="margin:20px 0;">
            <h4 style="text-align:center; color:#666;">éå»ã®çŒ®ç«‹å±¥æ­´</h4>
            <div id="menu-history" class="history-list"></div>
        </div>
    </div>

    <div id="tab-angry" class="container">
        <div class="box" style="border: 2px solid #333;">
            <h3>ğŸ§¸ ãƒ ã‚«ãƒƒã¨ããŸã‚‰â€¦</h3>
            <textarea id="angry-item" rows="4" placeholder="ï¼ˆä¾‹ï¼‰é´ä¸‹ãŒè„±ãã£ã±ãªã—ã§ã™ğŸ˜¡"></textarea>
            <button class="btn-black" onclick="submitAnger()">é€ä¿¡ã™ã‚‹ (ç›´æ¨¹ã¸é€šçŸ¥)</button>
        </div>
    </div>

    <div id="tab-schedule" class="container">
        <div class="box">
            <h3>ğŸ“… äºˆå®šç™»éŒ²</h3>
            <input type="text" id="event-name" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆå">
            <input type="date" id="event-date">
            <div class="radio-group">
                <input type="radio" name="owner" id="naoki" value="naoki"><label for="naoki" class="radio-label">ğŸ¢å°šè¼</label>
                <input type="radio" name="owner" id="maki" value="maki"><label for="maki" class="radio-label">ğŸ§¸çœŸè¼</label>
                <input type="radio" name="owner" id="common" value="common" checked><label for="common" class="radio-label">ğŸ 2äºº</label>
            </div>
            <button class="btn-green" onclick="submitEvent()">ç™»éŒ²</button>
            <hr style="margin:20px 0;">
            <h4 style="text-align:center; color:#666;">ä»Šå¾Œã®äºˆå®š</h4>
            <ul id="schedule-ul"></ul>
        </div>
    </div>

    <div id="tab-bucket" class="container">
        <div class="box">
            <h3>âœ¨ ã‚„ã‚ŠãŸã„ã“ã¨</h3>
            <input type="text" id="bucket-item" placeholder="ä¾‹ï¼šåŒ—æµ·é“ã§ã‚«ãƒ‹">
            <input type="date" id="bucket-limit">
            <select id="bucket-rank">
                <option value="â˜…">â˜… æ‰‹è»½</option>
                <option value="â˜…â˜…">â˜…â˜… æ™®é€š</option>
                <option value="â˜…â˜…â˜…">â˜…â˜…â˜… æŒ‘æˆ¦</option>
            </select>
            <div class="radio-group">
                <input type="radio" name="bucket-owner" id="b-naoki" value="naoki"><label for="b-naoki" class="radio-label">ğŸ¢å°šè¼</label>
                <input type="radio" name="bucket-owner" id="b-maki" value="maki"><label for="b-maki" class="radio-label">ğŸ§¸çœŸè¼</label>
                <input type="radio" name="bucket-owner" id="b-common" value="common" checked><label for="b-common" class="radio-label">ğŸ 2äºº</label>
            </div>
            <button class="btn-green" onclick="submitBucket()">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
        </div>
    </div>

    <div id="tab-pay" class="container">
        <div class="box">
            <h3>ğŸ’¸ ç«‹æ›¿è¨˜éŒ²</h3>
            <input type="text" id="pay-item" placeholder="ä½•ã«ä½¿ã£ãŸï¼Ÿ">
            <input type="number" id="pay-amount" placeholder="é‡‘é¡" inputmode="numeric">
            <div class="radio-group">
                <input type="radio" name="payer" id="pay-naoki" value="å°šè¼" checked><label for="pay-naoki" class="radio-label">ğŸ¢å°šè¼æ‰•</label>
                <input type="radio" name="payer" id="pay-maki" value="çœŸè¼"><label for="pay-maki" class="radio-label">ğŸ§¸çœŸè¼æ‰•</label>
            </div>
            <button class="btn-green" onclick="submitPayment()">è¨˜éŒ²</button>
        </div>
    </div>

    <div id="tab-love" class="container">
        <div class="box">
            <h3>â¤ï¸ æ„Ÿè¬ãƒã‚¤ãƒ³ãƒˆ</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn-blue" onclick="addPoint('naoki')">ğŸ¢ å°šè¼ã¸</button>
                <button class="btn-red" onclick="addPoint('maki')">ğŸ§¸ çœŸè¼ã¸</button>
            </div>
            <div class="point-box">
                <div class="point-card">ğŸ¢å°šè¼<br><span id="pt-naoki" class="point-num">0</span></div>
                <div class="point-card">ğŸ§¸çœŸè¼<br><span id="pt-maki" class="point-num">0</span></div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active-tab" onclick="switchTab('return')"><span class="nav-icon">ğŸ </span>å¸°</div>
        <div class="nav-item" onclick="switchTab('money')"><span class="nav-icon">ğŸ’°</span>é‡‘</div>
        <div class="nav-item" onclick="switchTab('scan')"><span class="nav-icon">ğŸ›’</span>åº•</div>
        <div class="nav-item" onclick="switchTab('list')"><span class="nav-icon">ğŸ“</span>è²·</div>
        <div class="nav-item" onclick="switchTab('menu')"><span class="nav-icon">ğŸ³</span>çŒ®</div>
        <div class="nav-item" onclick="switchTab('angry')"><span class="nav-icon">ğŸ§¸</span>æ€’</div>
        <div class="nav-item" onclick="switchTab('schedule')"><span class="nav-icon">ğŸ“…</span>äºˆ</div>
        <div class="nav-item" onclick="switchTab('bucket')"><span class="nav-icon">âœ¨</span>å¤¢</div>
        <div class="nav-item" onclick="switchTab('pay')"><span class="nav-icon">ğŸ’¸</span>ç«‹</div>
        <div class="nav-item" onclick="switchTab('love')"><span class="nav-icon">â¤ï¸</span>æ„Ÿ</div>
    </div>

    <script>
        // â˜…â˜…â˜…ã“ã“ã«GASã®URLã‚’è²¼ã‚‹â˜…â˜…â˜…
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwlhJC2PCJyTdeT2QxJ6fpV2tNnV7nXRsLAloi8e-TsXY4JDCCtHip5gvtVew5qth9z/exec";

        function switchTab(tabName) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-tab'));
            document.getElementById('tab-' + tabName).classList.add('active');
            const tabs = ['return','money','scan','list','menu','angry','schedule','bucket','pay','love'];
            const idx = tabs.indexOf(tabName);
            if(idx >= 0) document.querySelectorAll('.nav-item')[idx].classList.add('active-tab');

            if(tabName === 'list') loadShoppingList();
            if(tabName === 'menu') loadMenu();
            if(tabName === 'love') loadPoints();
            if(tabName === 'schedule') loadSchedules();
            if(tabName === 'money') {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('quick-date').value = now.toISOString().slice(0,16);
            }
        }
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const tab = params.get('tab');
            if (tab) switchTab(tab); else switchTab('return');
        }

        // --- 0. ä»Šã™ãå¸°ã‚Šã¾ã™ ---
        function quickReturn(who, mode) {
            document.getElementById('return-status').innerText = "ğŸ“ ä½ç½®æƒ…å ±å–å¾—ä¸­...";
            if (!navigator.geolocation) { alert("GPSåˆ©ç”¨ä¸å¯"); return; }
            navigator.geolocation.getCurrentPosition(async (pos) => {
                document.getElementById('return-status').innerText = "ğŸš€ è¨ˆç®—ä¸­...";
                const payload = { type: "web_app", action: "quick_return", lat: pos.coords.latitude, lon: pos.coords.longitude, owner: who, mode: mode };
                const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
                const data = await res.json();
                document.getElementById('return-status').innerText = (data.status === "success") ? "âœ… é€ä¿¡å®Œäº†ï¼" : "ã‚¨ãƒ©ãƒ¼";
                if(data.status==="success") alert(data.msg);
            }, (err) => { document.getElementById('return-status').innerText = "âš ï¸ GPSã‚¨ãƒ©ãƒ¼"; });
        }

        // --- 1. ç¬é–“å®¶è¨ˆç°¿ ---
        async function quickExpense(cat) {
            const date = document.getElementById('quick-date').value;
            const type = document.querySelector('input[name="quick-type"]:checked').value;
            const amount = document.getElementById('quick-amount').value;
            const store = document.getElementById('quick-store').value;
            const owner = document.querySelector('input[name="quick-owner"]:checked').value;
            const method = document.querySelector('input[name="quick-method"]:checked').value;
            
            if(!amount) return alert("é‡‘é¡ã‚’å…¥ã‚Œã¦ãã ã•ã„");
            if(confirm(`ã€${cat}ã€‘${amount}å††\næ—¥æ™‚ï¼š${date}\nç¨®é¡ï¼š${type}\näººï¼š${owner} (${method})\n\nè¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
                await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ 
                    type: "web_app", action: "quick_expense", 
                    date: date, type: type, amount: amount, category: cat, payer: owner, method: method, store: store 
                }) });
                alert("è¨˜éŒ²ã—ã¾ã—ãŸï¼ğŸ’°"); document.getElementById('quick-amount').value = ""; document.getElementById('quick-store').value = "";
            }
        }
        
        // --- 8. çŒ®ç«‹ (â˜…æ›´æ–°) ---
        async function submitMenu() {
            if(!confirm("ã“ã®å†…å®¹ã§çŒ®ç«‹ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return;
            const payload = {
                type: "web_app", action: "register_menu",
                mon: document.getElementById('menu-mon').value, tue: document.getElementById('menu-tue').value,
                wed: document.getElementById('menu-wed').value, thu: document.getElementById('menu-thu').value,
                fri: document.getElementById('menu-fri').value, sat: document.getElementById('menu-sat').value, sun: document.getElementById('menu-sun').value
            };
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
            alert("ä¿å­˜ã—ã¾ã—ãŸï¼ğŸ“…");
            loadMenu(); // ä¿å­˜å¾Œã«ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
        }
        function clearMenuInputs() {
            if(!confirm("å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return;
            document.getElementById('menu-mon').value = ""; document.getElementById('menu-tue').value = "";
            document.getElementById('menu-wed').value = ""; document.getElementById('menu-thu').value = "";
            document.getElementById('menu-fri').value = ""; document.getElementById('menu-sat').value = ""; document.getElementById('menu-sun').value = "";
        }
        async function loadMenu() {
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "get_menu" }) });
            const data = await res.json();
            // æœ€æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
            if(data.menu) {
                document.getElementById('menu-mon').value = data.menu.mon || ""; document.getElementById('menu-tue').value = data.menu.tue || "";
                document.getElementById('menu-wed').value = data.menu.wed || ""; document.getElementById('menu-thu').value = data.menu.thu || "";
                document.getElementById('menu-fri').value = data.menu.fri || ""; document.getElementById('menu-sat').value = data.menu.sat || ""; document.getElementById('menu-sun').value = data.menu.sun || "";
            }
            // å±¥æ­´ã‚’è¡¨ç¤º
            const historyDiv = document.getElementById('menu-history');
            historyDiv.innerHTML = "";
            if(data.history) {
                data.history.forEach(h => {
                    const d = new Date(h.date);
                    const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
                    historyDiv.innerHTML += `<div class="history-item"><strong>${dateStr}æ›´æ–°</strong><br>${h.menuStr}</div>`;
                });
            }
        }

        async function submitAnger() {
            const item = document.getElementById('angry-item').value;
            if(!item) return alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if(confirm(`ã€${item}ã€‘\n\né€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) {
                const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "register_anger", item: item, owner: "maki" }) });
                const data = await res.json();
                let msg = "é€ä¿¡ã—ã¾ã—ãŸã€‚";
                if (data.penalty) msg += `\n\nğŸš¨ 2å›è“„ç©ï¼\nğŸ° å°šè¼ã•ã‚“ã‹ã‚‰ã€Œãƒãƒƒã‚µãƒ¼ã‚¸orãƒ‡ã‚¶ãƒ¼ãƒˆã€ã®åˆ‘ãŒåŸ·è¡Œã•ã‚Œã¾ã™ã€‚`;
                alert(msg); document.getElementById('angry-item').value = "";
            }
        }

        async function submitEvent() { const name = document.getElementById('event-name').value; const date = document.getElementById('event-date').value; const owner = document.querySelector('input[name="owner"]:checked').value; if(!name || !date) return; if(confirm("ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) { await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "register_event", name: name, date: date, owner: owner }) }); alert("ç™»éŒ²å®Œäº†ï¼"); document.getElementById('event-name').value = ""; loadSchedules(); } }
        async function loadSchedules() {
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "get_schedules" }) });
            const data = await res.json();
            const ul = document.getElementById('schedule-ul'); ul.innerHTML = "";
            data.items.forEach(e => {
                const li = document.createElement('li');
                let icon = "ğŸ "; if(e.owner === "naoki") icon = "ğŸ¢"; if(e.owner === "maki") icon = "ğŸ§¸";
                const d = new Date(e.date);
                li.innerHTML = `${icon} ${d.getMonth()+1}/${d.getDate()} ${e.name}`;
                ul.appendChild(li);
            });
        }

        const scanner = new Html5Qrcode("reader");
        function startScan() { scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => { scanner.stop(); fetchItem(text); }); }
        async function fetchItem(jan) { const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "search_jan", jan: jan }) }); const data = await res.json(); document.getElementById('item').value = data.itemName || ""; }
        document.getElementById('price').addEventListener('input', () => { const p = document.getElementById('price').value, w = document.getElementById('weight').value; if(p&&w) document.getElementById('unit-result').innerText = `å˜ä¾¡ï¼š${Math.round((p/w)*100)} å††`; });
        async function submitPrice() { await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "register_price", item: document.getElementById('item').value, price: document.getElementById('price').value, weight: document.getElementById('weight').value, store: document.getElementById('store').value }) }); alert("ç™»éŒ²ã—ã¾ã—ãŸï¼"); }
        async function loadShoppingList() { const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "get_shopping_list" }) }); const data = await res.json(); const ul = document.getElementById('shopping-ul'); ul.innerHTML = ""; data.items.forEach(item => { const li = document.createElement('li'); li.innerHTML = `<span>${item}</span> <button class="delete-btn" onclick="deleteItem('${item}')">å®Œäº†</button>`; ul.appendChild(li); }); }
        async function addListItem() { const item = document.getElementById('list-input').value; if(!item) return; await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "add_shopping_item", item: item }) }); document.getElementById('list-input').value = ""; loadShoppingList(); }
        async function deleteItem(item) { if(!confirm("è²·ã„ã¾ã—ãŸã‹ï¼Ÿ")) return; await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "delete_shopping_item", item: item }) }); loadShoppingList(); }
        async function submitBucket() { const item = document.getElementById('bucket-item').value; const owner = document.querySelector('input[name="bucket-owner"]:checked').value; const limit = document.getElementById('bucket-limit').value; const rank = document.getElementById('bucket-rank').value; if(!item) return; if(confirm(`ã€${item}ã€‘\n\nã‚„ã‚ŠãŸã„ã“ã¨ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) { await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "register_bucket", item: item, owner: owner, limit: limit, rank: rank }) }); alert("è¿½åŠ ã—ã¾ã—ãŸï¼âœ¨"); document.getElementById('bucket-item').value = ""; } }
        async function submitPayment() { const item = document.getElementById('pay-item').value; const amount = document.getElementById('pay-amount').value; const payer = document.querySelector('input[name="payer"]:checked').value; if(!item || !amount) return; if(confirm(`${payer}ãŒ ${amount}å††\n(${item})\n\nè¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) { await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "register_payment", item: item, amount: amount, payer: payer }) }); alert("è¨˜éŒ²ã—ã¾ã—ãŸï¼"); document.getElementById('pay-item').value = ""; document.getElementById('pay-amount').value = ""; } }
        async function addPoint(to) { let confirmMsg = (to === 'naoki') ? "å°šè¼ã•ã‚“ã«æ„Ÿè¬ã‚’ä¼ãˆã¾ã™ã‹ï¼Ÿ" : "çœŸè¼ã•ã‚“ã«æ„Ÿè¬ã‚’ä¼ãˆã¾ã™ã‹ï¼Ÿ"; if(confirm(confirmMsg)) { const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "add_point", to: to }) }); const data = await res.json(); if (data.reward) { let msg = (to === 'naoki') ? `ğŸ‰ ç¥ï¼å°šè¼ã•ã‚“ãŒ ${data.total}ãƒã‚¤ãƒ³ãƒˆé”æˆï¼\n\nğŸ’†â€â™€ï¸ çœŸè¼ã•ã‚“ã€å°šè¼ã•ã‚“ã«\nã€Œãƒãƒƒã‚µãƒ¼ã‚¸ã€ã‚’ã—ã¦ã‚ã’ã¦ãã ã•ã„ï¼` : `ğŸ‰ ç¥ï¼çœŸè¼ã•ã‚“ãŒ ${data.total}ãƒã‚¤ãƒ³ãƒˆé”æˆï¼\n\nğŸ’†â€â™‚ï¸ å°šè¼ã•ã‚“ã€çœŸè¼ã•ã‚“ã«\nã€Œãƒãƒƒã‚µãƒ¼ã‚¸ã€ã‚’ã—ã¦ã‚ã’ã¦ãã ã•ã„ï¼`; alert(msg); } else { alert(`æ„Ÿè¬ã‚’ä¼ãˆã¾ã—ãŸï¼\n(ç¾åœ¨: ${data.total}ãƒã‚¤ãƒ³ãƒˆ)`); } loadPoints(); } }
        async function loadPoints() { const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "web_app", action: "get_points" }) }); const data = await res.json(); document.getElementById('pt-naoki').innerText = data.naoki; document.getElementById('pt-maki').innerText = data.maki; }
    </script>
</body>
</html>
